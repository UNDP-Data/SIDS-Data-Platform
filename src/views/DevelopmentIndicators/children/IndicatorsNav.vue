<template>
  <div class="indicators-nav">
    <v-btn
        class="close-button d-block dense d-md-none"
        icon
        @click="$emit('close')"
        color="primary"
      >
      <v-icon>mdi-close</v-icon>
    </v-btn>
    <v-card flat>
      <v-text-field v-if="!dataset"
        class="search-input mx-4 py-4"
        dense
        v-model="searchString"
        @focus="showFullList"
        @blur="hideFullList"
        hide-details
        @click:append="clearFullSearch"
        :append-icon="searchString!=='' ? 'mdi-close' : ''"
        prepend-icon="mdi-magnify"
      ></v-text-field>

    <v-virtual-scroll
      v-if="activeSearch"
      :items="allindicators"
      bench='12'
      :height="inticatorsFullListHeight"
      itemHeight="69"
      >
      <template v-slot:default="{ item }">
        <v-menu
          right
          offset-x
          nudge-right="20"
          open-delay="300"
          close-delay="300"
          :internal-activator="true"
          transition="none"
          :key="item.indicator"
          content-class="tooltip-content"
         >
          <template v-slot:activator="{ on, attrs }">
            <v-list-item
              class="inicator-item"
              v-bind="attrs"
              v-on="on"
              :disabled="getDimensionAvaliability(item.indicatorCode)"
              @click="emitindicatorChange(item['indicatorCode'])"
            >
              <v-list-item-title class="inicator-item_header mt-2">
                {{item.indicator}}
              </v-list-item-title>
              <v-list-item-content class="inicator-item_description">
                {{item.def}}
              </v-list-item-content>
            </v-list-item>
            <v-divider></v-divider>
          </template>
          <v-card class="tooltip-card">
            <v-card-title class="mb-1 active-indicator_header">{{item.indicator}}</v-card-title>
            <v-card-text>
              <div class="mb-1">{{item.units}}</div>
              {{item.def}}
              <v-divider class="mb-1 mt-1"></v-divider>
              <b>{{$t('root.source')}}::</b> {{item.source}} <br/>
              <a :href="item.link" class="undp-style" target="_blank">{{$t('root.link')}}:</a>
            </v-card-text>
          </v-card>
        </v-menu>
      </template>
    </v-virtual-scroll>
    <v-list v-if="!activeSearch" dense :class="{'list-datasets-active':dataset}" class="list-datasets">
      <v-list-item-group>
        <template v-for="(item, i) in datasets" >

          <v-tooltip
            right
            open-delay="300"
            transition="none"
            max-width="250"
            :key="i"
            content-class="tooltip-content"
           >
            <template v-slot:activator="{ on, attrs }">
              <v-list-item
                v-show="!dataset || dataset === item"
                v-if="datasetsWithIcons.includes(item) || dataset === item"
                class="list-scrollabe_item dataset-item pt-4"
                :class="{'dataset-item-active':dataset === item}"
                :key="item"
                v-bind="attrs"
                v-on="on"
                @click="toggleDataset(item)"
              >
                <v-list-item-icon class="dataset-item-icon" v-show="dataset === item">
                  <v-icon>mdi-arrow-left</v-icon>
                </v-list-item-icon>
                <v-list-item-content>
                  <v-img
                    contain
                    :max-height="dataset === item ? 40 :50 "
                    :src="`${apiPath}/assets/indicator-icons/${item}.png`"
                  ></v-img>
                </v-list-item-content>
              </v-list-item>
            </template>

            <v-card v-if="datasetsWithIcons.includes(item)" class="tooltip-card pt-2">
              <v-img
                contain
                max-height="50"
                :src="`${apiPath}/assets/indicator-icons/${item}.png`"
              ></v-img>
              <v-card-title class="mb-1 active-indicator_header">{{datasetMeta[item] ? datasetMeta[item].datasetName : ''}}</v-card-title>
              <v-card-text>
                <div class="mb-1">
                  {{datasetMeta[item] ? datasetMeta[item].numIndicators : ''}} indicators
                  {{datasetMeta[item] ? datasetMeta[item].numCountries : ''}} SIDS

                </div>
                <b>Organization:</b>{{datasetMeta[item] ? datasetMeta[item].organization : ''}}
              </v-card-text>
            </v-card>
          </v-tooltip>
        </template>
      </v-list-item-group>
    </v-list>
    <div class="mx-4">
      <v-select
      v-if="dataset && indicatorCategories"
      class="my-6 undp-select"
      dense
      v-model="activeCategory"
      hide-details
      @change="changeCategory"
      :items="indicatorCategories"
    >
      <template slot="selection" slot-scope="data">
        <span class="select-text-element">{{data.item === 'allCategories' ? $t('indicators.forms.allCategories') : data.item}}</span>
      </template>
      <template slot="item" slot-scope="data">
        {{data.item === 'allCategories' ? $t('indicators.forms.allCategories') : data.item}}
      </template>
    </v-select>
    <v-select
      v-if="dataset && indicatorSubCategories && indicatorSubCategories.length > 1"
      class="undp-select"
      dense
      hide-details
      v-model="activeSubCategory"
      :items="indicatorSubCategories"
    >
      <template slot="selection" slot-scope="data">
        <span class="select-text-element">{{data.item === 'allSubcategories' ? $t('indicators.forms.allSubcategories') : data.item}}</span>
      </template>
      <template slot="item" slot-scope="data">
        {{data.item === 'allSubcategories' ? $t('indicators.forms.allSubcategories') : data.item}}
      </template>
    </v-select>
    </div>

    <v-text-field v-if="dataset"
        class="search-input mx-4 mb-4"
        v-model="deepSearch"
        hide-details
        dense
        :append-icon="searchString!=='' ? 'mdi-close' : ''"
        prepend-icon="mdi-magnify"
        @click:append="clearDeepSearch"
    ></v-text-field>
    <v-virtual-scroll
      v-if="dataset"
      bench='12'
      :items="activeIndicatorsWithMeta"
      :height="inticatorsListHeight"
      itemHeight="69"
    >
    <template v-slot:default="{ item, index }">
          <v-menu
            right
            offset-x
            nudge-right="20"
            open-delay="300"
            close-delay="300"
            transition="none"
            max-width="250"
            open-on-hover
            :key="item['indicatorCode']"
            content-class="tooltip-content"
           >
            <template v-slot:activator="{ on, attrs }">
              <v-list-item
                class="inicator-item"
                :class="{'blue lighten-5': item['indicatorCode'] === activeIndicatorCode}"
                v-bind="attrs"
                v-on="on"
                :disabled="getDimensionAvaliability(item.indicatorCode)"
                @click="emitindicatorChange(item['indicatorCode'])"
              >
                <v-list-item-title class="inicator-item_header mt-2">
                  {{item.indicator}}
                </v-list-item-title>
                <v-list-item-content class="inicator-item_description">
                  {{item.def}}
                </v-list-item-content>
              </v-list-item>
              <v-divider v-if="dataset && index!== activeIndicatorsWithMeta.length" :key="'divider' + index"></v-divider>
            </template>
            <v-card class="tooltip-card">
              <v-card-title class="mb-1 active-indicator_header">{{item.indicator}}</v-card-title>
              <v-card-text>
                <div class="mb-1">{{item.dim}}</div>
                <v-divider class="mb-1 mt-1"></v-divider>
                <b>Source:</b> {{item.source}} <br/>
                <a :href="item.link" class="undp-style" target="_blank">Link</a>
              </v-card-text>
            </v-card>
          </v-menu>
        </template>
    </v-virtual-scroll>
  </v-card>
  <v-card flat class="mt-2 active-indicator-info" v-if="activeIndicator && !isSmallScreen">
    <v-card-title class="mb-1 active-indicator_header">{{activeIndicator.indicator}} ({{activeIndicator.units}})</v-card-title>
    <v-card-text class="pt-1">
      <div class="mb-2 d-flex">
        <div class="d-flex align-center mr-2"><p class="input-label mb-0">Year</p></div>
        <v-select class='dimensions-select-button undp-select'
          :items="activeIndicatorYears"
          :value="year"
          item-text="name"
          item-value="id"
          :disabled="playingYear || chartType==='series'"
          @change="emitYearChange"
          dense
          hide-details
        >
          <template slot="selection" slot-scope="data">
            <span class="select-text-element">{{data.item.id === 'recentValue' ? $t('indicators.forms.recent') : data.item.name}}</span>
          </template>
          <template slot="item" slot-scope="data">
            {{data.item.id === 'recentValue' ? $t('indicators.forms.recent') : data.item.name}}
          </template>
        </v-select>
        <v-btn
          class="mt-3"
          @click="toggleYearPlay"
          :disabled="chartType==='series' || activeIndicatorYears.length === 1"
          icon
          >
          <v-icon v-if="playingYear">mdi-pause</v-icon>
          <v-icon v-else>mdi-play</v-icon>
        </v-btn>
      </div>
      <div class="mb-2 d-flex" style="width: 100%;">
        <div class="d-flex align-center mr-2"><p v-if="activeIndicatorDimensions.length > 1" class="input-label mb-0">{{$t('indicators.forms.dimension')}}</p></div>
        <div class="align-right" style="width: 100%;">
          <v-select class='dimensions-select-button undp-select' v-if="activeIndicatorDimensions.length > 1"
          :items="activeIndicatorDimensions"
          :value="activeIndicatorCode"
          item-text="dimension"
          :item-disabled="getDimensionAvaliability"
          item-value="code"
          :disabled="playingYear"
          @change="emitindicatorChange"
          dense
          hide-details
        ></v-select>
        </div>
      </div>
      {{activeIndicator.def}}
      <v-divider class="mb-1 mt-1"></v-divider>
      <b>{{$t('root.source')}}:</b> {{activeIndicator.source}} <br/>
      <a :href="activeIndicator.link" target="_blank" class="undp-style">{{$t('root.link')}}</a>
    </v-card-text>
  </v-card>
  </div>
</template>
<script>
/*global gtag*/
import { mapState } from 'vuex';


export default {
  name: 'indicatorsNav',
  props:['activeIndicatorCode', 'year', 'chartType'],
  data() {
    return {
      activeSearch: false,
      searchString: '',
      playingYear:false,
      playInterval:null,
      dataset: null,
      deepSearch:'',
      activeIndicatorDimension:null,
      activeCategory: 'allCategories',
      activeSubCategory: 'allSubcategories',
      activeIndicator:null,
      apiPath: process.env.VUE_APP_API_PATH,
      datasetsWithIcons: [
        'blasiak',
        'epi',
        'fao',
        'gggr',
        'ghi',
        'hdr',
        'igrac',
        'ihme',
        'irena 2',
        'irena',
        'itu',
        'key',
        'mvi',
        'ndgain',
        'ohi',
        'oecd',
        'paris',
        'pci',
        'rfti',
        'sdg',
        'ssi',
        'unctad',
        'unicef',
        'undesa',
        'wdi',
        'who'
      ]
    }
  },
  computed: {
    ...mapState({
      indicatorsCategories: state => state.indicators.indicatorsCategories,
      indicatorsMeta: state => state.indicators.indicatorsMeta,
      datasetMeta: state => state.indicators.datasetsMeta,
      datasets: state => state.indicators.datasetsList,
      data: state => state.indicators.activeIndicatorData,
      MLTargetSize: state => state.indicators.MLTargetSize
    }),
    activeDataset() {
      if(this.dataset) {
        return this.indicatorsCategories[this.dataset];
      }
      return null
    },
    isSmallScreen() {
      return this.$vuetify.breakpoint.xs || this.$vuetify.breakpoint.sm || this.$vuetify.breakpoint.md
    },
    activeIndicatorYears(){
      if(this.data && this.data.data) {
        return Object.keys(this.data.data).filter(year => year !== 'recentYear').map(year => {
          return {
            name: year === 'recentValue' ? 'Recent value' : year,
            id: year
          }
        }).reverse()
      } else {
        return []
      }
    },
    indicatorCategories() {
      if(this.activeDataset) {
        let categories = Object.keys(this.activeDataset);
        categories = categories.filter((categoriy) => { return categoriy !== 'None' });
        categories.push('allCategories')
        return categories
      }
      return null
    },
    indicatorSubCategories() {
      if(this.activeCategory !== 'allCategories') {
        let categories = Object.keys(this.activeDataset[this.activeCategory]);
        categories = categories.filter((categoriy) => { return categoriy !== 'none' && categoriy !== 'None' });
        categories.push('allSubcategories')
        return categories
      }
      return null
    },
    allindicators() {
      let indicatorsArray = [];
      for(let indicator in this.indicatorsMeta) {
        indicatorsArray.push(this.indicatorsMeta[indicator])
      }
      indicatorsArray.sort(function(a, b) {
          var textA = a.indicator.toUpperCase();
          var textB = b.indicator.toUpperCase();
          return (textA < textB) ? -1 : (textA > textB) ? 1 : 0;
      });
      if(this.searchString !=='') {
        return indicatorsArray.filter(indicator => {
          return indicator.Dataset !== 'key' && indicator.indicator.toLowerCase().includes(this.searchString.toLowerCase()) && indicator.codesArray[0] === indicator.indicatorCode;
        })
      }
      return indicatorsArray;
    },
    activeIndicators() {
      let indicatorsArray = [];
      if(this.activeCategory && this.activeCategory !== 'allCategories') {
        if(this.activeSubCategory && this.activeSubCategory !== 'allSubcategories') {
          return this.getSubcategoryindicators(this.activeCategory, this.activeSubCategory)
        }
        for(let subCategory in this.activeDataset[this.activeCategory]) {
          indicatorsArray = indicatorsArray.concat(this.getSubcategoryindicators(this.activeCategory, subCategory))
        }
      } else {
        for(let category in this.activeDataset) {
          for(let subCategory in this.activeDataset[category]) {
            indicatorsArray = indicatorsArray.concat(this.getSubcategoryindicators(category, subCategory))
          }
        }
      }
      return indicatorsArray
    },
    activeIndicatorsWithMeta() {
      let indicatorsWithMetaArray = this.activeIndicators.map(codesArray => {
        codesArray.map(code =>  {
          let metaData = this.indicatorsMeta[code];
          metaData.codesArray = codesArray;
        })
        let metaData = this.indicatorsMeta[codesArray[0]];
        metaData.codesArray = codesArray;
        return metaData;
      })
      indicatorsWithMetaArray.sort(function(a, b) {
          var textA = a.indicator.toUpperCase();
          var textB = b.indicator.toUpperCase();
          return (textA < textB) ? -1 : (textA > textB) ? 1 : 0;
      });
      if(this.deepSearch !== '') {
        return indicatorsWithMetaArray.filter(indicator => {
          return indicator.indicator.toLowerCase().includes(this.deepSearch.toLowerCase());
        })
      }
      return indicatorsWithMetaArray;
    },
    activeIndicatorDimensions() {
      return this.activeIndicator.codesArray.map(code => {
        return {
          code,
          dimension: this.indicatorsMeta[code].dim
        }
      })
    },
    inticatorsFullListHeight() {
      let height = '100vh',
      substraction = 130;
      if(!this.isSmallScreen) {
        substraction = 78
      }
      return `calc(${height} - ${substraction}px)`
    },
    inticatorsListHeight() {
      let height = '100vh',
      substraction = 240;
      if(this.activeIndicator && !this.isSmallScreen) {
        height = '50vh'
        substraction = 128
      }
      if(this.activeCategory && this.indicatorSubCategories &&  this.indicatorSubCategories.length>1) {
        substraction+=40
      }
      return `calc(${height} - ${substraction}px)`
    }
  },
  methods: {
    toggleDataset(name) {
      this.activeCategory = 'allCategories';
      this.activeSubCategory = 'allSubcategories';
      this.activeIndicator = null;
      if(this.dataset === name) {
        this.dataset = null;
      } else {
        this.dataset = name;
      }
    },
    selectDataset(name) {
      if(name !== this.dataset) {
        this.activeCategory = 'allCategories';
        this.activeSubCategory = 'allSubcategories';
        this.dataset = name;
      }
    },
    getSubcategoryindicators(category, subCategory) {
      let indicatorsList = [];
      for(let indicator in this.activeDataset[category][subCategory]) {
        indicatorsList.push(this.activeDataset[category][subCategory][indicator]);
      }
      return indicatorsList
    },
    changeCategory() {
      this.activeSubCategory = 'allSubcategories'
    },
    emitindicatorChange(indicator) {
      this.$emit('indicatorChange', indicator)
      gtag('event', 'indi_select', {
        indicator
      });
      if(this.isSmallScreen){
        this.$emit('close', indicator)
      }
    },
    emitYearChange(year) {
      gtag('event', 'indi_year', {
        year
      });
      this.$emit('yearChange', year)
    },
    setActiveindicator(indicator) {
      this.activeIndicator = indicator;
      this.activeIndicatorDimension = indicator.dim;
    },
    showFullList() {
      gtag('event', 'indi_search', {
      });
      this.activeSearch = true;
    },
    hideFullList() {
      if(this.searchString === '') {
        setTimeout(() => {
          this.activeSearch = false;
        }, 200);
      }
    },
    setActiveindicatorFromFullList(indicator) {
      this.searchString = '';
      this.activeSearch = false;
      this.selectDataset(indicator.dataset);
      this.setActiveindicator(indicator);
    },
    clearFullSearch() {
      this.searchString = '';
      this.activeSearch = false;
    },
    clearDeepSearch() {
      this.deepSearch = '';
    },
    toggleYearPlay() {
      if(this.playingYear) {
        this.pausePlayYear()
      } else {
        this.playYear()
      }
    },
    playYear() {
      this.playingYear = true;
      if(this.playInterval) {
        clearTimeout(this.playInterval)
      }
      let years = this.activeIndicatorYears.slice().reverse();
      let index = 0;
      this.transitionToNextYear(years, index)
    },
    transitionToNextYear(years, index) {
      if(this.playingYear) {
        if(index !== this.activeIndicatorYears.length-1) {
          this.emitYearChange(years[index].id);
          index++;
          this.playInterval = setTimeout(()=>{this.transitionToNextYear(years, index)}, 3000)
        } else {
          this.pausePlayYear()
        }
      } else {
        clearTimeout(this.playInterval)
      }
    },
    getDimensionAvaliability(code) {
      let codeParsed = code.code || code;
      if(this.chartType !== 'ml') {
        return false
      }

      return !Object.values(this.indicatorsMeta[codeParsed].yearValueCounts).some(v=>v >= this.MLTargetSize);
    },
    pausePlayYear() {
      clearTimeout(this.playInterval)
      this.playingYear = false;
    }
  },
  watch:{
    activeIndicatorCode() {
      let activeIndicator = this.allindicators.find(indicator => indicator['indicatorCode'] === this.activeIndicatorCode)
      if(activeIndicator) {
        this.setActiveindicatorFromFullList(activeIndicator)
      }
    }
  },
  mounted() {
    let activeIndicator = this.allindicators.find(indicator => indicator['indicatorCode'] === this.activeIndicatorCode)
    if(activeIndicator) {
      this.setActiveindicatorFromFullList(activeIndicator)
    }
  }
}
</script>

<style>
.list-scrollabe {
  overflow-y: scroll;
}
.list-datasets {
  max-height: calc(100vh - 68px);
}
.list-datasets-active {
  padding: 0;
}
.list-indicators {
  max-height: calc(100vh - 200px);
}
.list-short {
  max-height: calc(100vh - 128px);
}
.list-scrollabe_item {
  height: 66px;
}
.list-scrollabe_item.dataset-item-active {
  height: 70px;
}
.inicator-item {
  display: flex;
  min-height: 68px;
  flex-direction: column;
}
.inicator-item_header {
  text-align: left;
  font-weight: 800 !important;
  width: 100%;
}
.inicator-item_description {
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
  width: 100%;
  display: block;
  font-size: 12px;
}
.inicator-item::after {
  min-height: 0;
}
.active-indicator_header {
  padding-bottom: 0.5em;
  word-break: break-word;
  font-size: 16px !important;
  line-height: 22px !important;
}
.dimensions-select-button{
  margin-right: 0;
}
.active-indicator-info {
  max-height: calc(50vh - 50px);
  overflow-y: scroll;
}
.indicators-nav {
  padding: relative;
}
.close-button {
  position: absolute !important;
  top: 5px;
  right: 5px;
  z-index: 5;
}
.theme--light.v-list-item--active.dataset-item::before {
  opacity: 0;
}
.theme--light.v-list-item--active.v-list-item:hover::before {
  opacity: 0.04;
}
.dataset-item-icon {
  margin: auto 10px auto 0px !important;
}
.search-input {
  margin: 0;
}
.search-input .v-input__prepend-outer{
  margin: auto 0px auto 0 !important;
  padding-top: 7px;
}
@media (max-width:959px) {
  .list-datasets {
    max-height: calc(100vh - 128px)
  }
}
</style>
